// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  ATENDENTE
}

enum StatusRetencao {
  CANCELADO
  RETIDO
  INADIMPLENCIA
}

enum Regiao {
  SINOS
  LITORAL
  MATRIZ
}

enum MotivoCancelamento {
  INSATISFACAO_ATD
  INSATISFACAO_SERVICO
  MUDANCA_ENDERECO
  MOTIVOS_PESSOAIS
  TROCA_PROVEDOR
  PROBLEMAS_FINANC
  OUTROS
  INADIMPLENCIA_90  // usado automaticamente quando status = INADIMPLENCIA
}

// Cidade agora é uma tabela editável (antes era enum)
model Cidade {
  id        String   @id          // ex: "CACHOEIRINHA" — mesmo valor do antigo enum
  nome      String                // ex: "Cachoeirinha" — nome legível
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  solicitacoes SolicitacaoRetencao[]
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(ATENDENTE)
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  solicitacoes SolicitacaoRetencao[] @relation("AtendenteSolicitacoes")
}

model Competencia {
  id                String   @id @default(cuid())
  ano               Int
  mes               Int

  metaCancelamentos Int?
  orcamentoComissaoCents Int?
  baseAtivosTotal   Int?
  inadimplenciaTotal Int?

  diasUteis         Int?
  diasTrabalhados   Int?
  metaDiariaManual  Int?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  solicitacoes      SolicitacaoRetencao[]

  @@unique([ano, mes])
}

model SolicitacaoRetencao {
  id             String       @id @default(cuid())

  competenciaId  String
  competencia    Competencia  @relation(fields: [competenciaId], references: [id], onDelete: Cascade)

  dataRegistro   DateTime
  status         StatusRetencao

  nomeCliente    String
  bairro         String?
  contato        String?

  cidade         String
  cidadeInfo     Cidade       @relation(fields: [cidade], references: [id])

  regiao         Regiao

  agendaRetirada DateTime?
  retiradaTexto  String?

  atendenteId    String
  atendente      User         @relation("AtendenteSolicitacoes", fields: [atendenteId], references: [id])

  motivo         MotivoCancelamento?
  observacoes    String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([competenciaId, status])
  @@index([competenciaId, motivo])
  @@index([atendenteId])
  @@index([cidade])
  @@index([regiao])
}
